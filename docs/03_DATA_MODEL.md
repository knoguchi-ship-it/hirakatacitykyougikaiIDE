# データモデル設計書（スプレッドシートDB版）

## 1. 設計方針
- JSON列へ丸ごと保存する方式は採用しない。
- スプレッドシートを「マスタ」と「トランザクションテーブル」に分割する。
- 1シート1責務、1行1レコード、主キー/外部キー列を明示する。
- 列名・マスタ名・テーブル名はすべて日本語命名とする。

## 2. マスタ一覧

### 2.1 `M_会員種別`
- 用途: 会員の区分管理
- 列:
  - `コード` (PK)
  - `名称`
  - `表示順`
  - `有効フラグ`

### 2.2 `M_会員状態`
- 用途: 会員状態の管理
- 列: `コード`, `名称`, `表示順`, `有効フラグ`

### 2.3 `M_発送方法`
- 用途: 通知媒体（メール/郵送）
- 列: `コード`, `名称`, `表示順`, `有効フラグ`

### 2.4 `M_郵送先区分`
- 用途: 定期郵送先（自宅/勤務先）
- 列: `コード`, `名称`, `表示順`, `有効フラグ`

### 2.5 `M_職員権限`
- 用途: 事業所職員の権限
- 列: `コード`, `名称`, `表示順`, `有効フラグ`

### 2.6 `M_職員状態`
- 用途: 在籍/退職
- 列: `コード`, `名称`, `表示順`, `有効フラグ`

### 2.7 `M_システムロール`
- 用途: ログイン主体ごとのシステム権限
- 列: `コード`, `名称`, `表示順`, `有効フラグ`
- 初期値:
  - `OFFICE_ADMIN`（事務局管理者）
  - `INDIVIDUAL_MEMBER`（個人会員）
  - `BUSINESS_ADMIN`（事業所管理者）
  - `BUSINESS_MEMBER`（事業所メンバー）

### 2.8 `M_開催形式`
- 用途: 研修の形式（オンライン/現地）
- 列: `コード`, `名称`, `表示順`, `有効フラグ`

### 2.9 `M_研修状態`
- 用途: 受付中/受付終了
- 列: `コード`, `名称`, `表示順`, `有効フラグ`

### 2.10 `M_申込状態`
- 用途: 申込状態（申込済/取消）
- 列: `コード`, `名称`, `表示順`, `有効フラグ`

### 2.11 `M_会費納入状態`
- 用途: 年会費の納入状態
- 列: `コード`, `名称`, `表示順`, `有効フラグ`

## 3. テーブル一覧

### 3.1 `T_会員`
- 用途: 会員基本情報
- 主キー: `会員ID`
- 列:
  - `会員ID` (PK)
  - `会員種別コード` (FK -> `M_会員種別.コード`)
  - `会員状態コード` (FK -> `M_会員状態.コード`)
  - `姓`
  - `名`
  - `セイ`
  - `メイ`
  - `代表メールアドレス`
  - `携帯電話番号`
  - `勤務先名`
  - `勤務先郵便番号`
  - `勤務先都道府県`
  - `勤務先市区町村`
  - `勤務先住所`
  - `勤務先電話番号`
  - `勤務先FAX番号`
  - `自宅郵便番号`
  - `自宅都道府県`
  - `自宅市区町村`
  - `自宅住所`
  - `発送方法コード` (FK -> `M_発送方法.コード`)
  - `郵送先区分コード` (FK -> `M_郵送先区分.コード`)
  - `作成日時`
  - `更新日時`
  - `削除フラグ`

### 3.2 `T_事業所職員`
- 用途: 事業所に紐づく職員
- 主キー: `職員ID`
- 外部キー: `会員ID` -> `T_会員.会員ID`
- 列:
  - `職員ID` (PK)
  - `会員ID` (FK)
  - `氏名`
  - `フリガナ`
  - `メールアドレス`
  - `職員権限コード` (FK -> `M_職員権限.コード`)
  - `職員状態コード` (FK -> `M_職員状態.コード`)
  - `作成日時`
  - `更新日時`
  - `削除フラグ`

### 3.3 `T_研修`
- 用途: 研修マスタ兼トランザクション
- 主キー: `研修ID`
- 列:
  - `研修ID` (PK)
  - `研修名`
  - `開催日`
  - `定員`
  - `申込者数`
  - `開催場所`
  - `開催形式コード` (FK -> `M_開催形式.コード`)
  - `研修状態コード` (FK -> `M_研修状態.コード`)
  - `作成日時`
  - `更新日時`
  - `削除フラグ`

### 3.4 `T_認証アカウント`
- 用途: 本システムのログインID/パスワード管理の基準テーブル
- 主キー: `認証ID`
- 外部キー:
  - `システムロールコード` -> `M_システムロール.コード`
  - `会員ID` -> `T_会員.会員ID`
  - `職員ID` -> `T_事業所職員.職員ID`（事業所会員のみ）
- 列:
  - `認証ID` (PK)
  - `ログインID` (Unique)
  - `パスワードハッシュ`
  - `パスワードソルト`
  - `システムロールコード` (FK)
  - `会員ID` (FK)
  - `職員ID` (FK, NULL可)
  - `最終ログイン日時`
  - `パスワード更新日時`
  - `アカウント有効フラグ`
  - `ログイン失敗回数`
  - `ロック状態`
  - `作成日時`
  - `更新日時`
  - `削除フラグ`
- 備考:
  - パスワード平文は保存しない（ハッシュ+ソルトのみ保持）。
  - 全ての業務データのアクセス判定はこのテーブルを起点に行う。

### 3.5 `T_ログイン履歴`
- 用途: 監査ログ（成功/失敗追跡）
- 主キー: `ログイン履歴ID`
- 外部キー: `認証ID` -> `T_認証アカウント.認証ID`
- 列:
  - `ログイン履歴ID` (PK)
  - `認証ID` (FK)
  - `ログインID`
  - `ログイン結果`
  - `失敗理由`
  - `接続元IP`
  - `ユーザーエージェント`
  - `実行日時`

### 3.6 `T_画面項目権限`
- 用途: ロール別の項目単位権限
- 主キー: `権限定義ID`
- 外部キー: `システムロールコード` -> `M_システムロール.コード`
- 列:
  - `権限定義ID` (PK)
  - `システムロールコード` (FK)
  - `画面コード`
  - `項目コード`
  - `閲覧可`
  - `登録可`
  - `変更可`
  - `削除可`
  - `作成日時`
  - `更新日時`
  - `削除フラグ`
- 備考:
  - 事業所管理者と事業所メンバーの差分は本テーブルで制御する。

### 3.7 `T_研修申込`
- 用途: 会員/職員単位の申込履歴（中間テーブル）
- 主キー: `申込ID`
- 外部キー:
  - `研修ID` -> `T_研修.研修ID`
  - `会員ID` -> `T_会員.会員ID`
  - `職員ID` -> `T_事業所職員.職員ID`（個人会員は空許容）
- 列:
  - `申込ID` (PK)
  - `研修ID` (FK)
  - `会員ID` (FK)
  - `職員ID` (FK, NULL可)
  - `申込状態コード` (FK -> `M_申込状態.コード`)
  - `申込日時`
  - `取消日時`
  - `備考`
  - `作成日時`
  - `更新日時`
  - `削除フラグ`

### 3.8 `T_年会費納入履歴`
- 用途: 年度別会費状態
- 主キー: `年会費履歴ID`
- 外部キー: `会員ID` -> `T_会員.会員ID`
- 列:
  - `年会費履歴ID` (PK)
  - `会員ID` (FK)
  - `対象年度`
  - `会費納入状態コード` (FK -> `M_会費納入状態.コード`)
  - `納入確認日`
  - `金額`
  - `備考`
  - `作成日時`
  - `更新日時`
  - `削除フラグ`

### 3.9 `T_管理者Googleホワイトリスト`
- 用途: 管理者Googleログイン許可リスト
- 主キー: `ホワイトリストID`
- 外部キー:
  - `紐付け認証ID` -> `T_認証アカウント.認証ID`
  - `紐付け会員ID` -> `T_会員.会員ID`
- 列:
  - `ホワイトリストID` (PK)
  - `GoogleユーザーID` (Unique 推奨)
  - `Googleメール`
  - `表示名`
  - `紐付け認証ID` (FK)
  - `紐付け会員ID` (FK)
  - `有効フラグ`
  - `作成日時`
  - `更新日時`
  - `削除フラグ`

## 4. 実装メモ（GAS）
- `backend/Code.gs` の `setupDatabase()` で上記シートを自動生成する。
- `setupDatabase()` 実行時に、定義外シート（例: `シート1`）を自動削除する。
- マスタ参照列には入力規則（ドロップダウン）を設定し、コード値のみ入力可能にする。
- ヘッダー行は保護（警告表示）し、誤編集を防ぐ。
- `T_画面項目権限` は初期権限行を自動投入する。
- 再構築用に `rebuildDatabaseSchema()` を用意し、定義外シート削除を含めて再適用できる。
- 清掃専用に `cleanupDatabaseSheets()` を用意し、定義外シートのみ削除できる。

## 5. 認証・権限の運用ルール
- 全処理は `T_認証アカウント` を起点に認可判定する（会員/職員テーブルの直接参照のみで判定しない）。
- `ログインID` は一意制約として運用する（重複不可）。
- `パスワードハッシュ` と `パスワードソルト` のみ保存し、平文は保存しない。
- ログイン結果は `T_ログイン履歴` に記録し、失敗回数・ロック状態を更新する。
- 画面ごとの項目操作可否は `T_画面項目権限` で管理する（事業所管理者/事業所メンバー差分を含む）。

## 5.1 認証方式の追加運用（会員ID/PW + 管理者Google）
- 会員ログインは `ログインID + パスワード` を使用する（Googleログインは使わない）。
- 管理者ログインは Google アカウントの IDトークン検証で行う。
- 管理者ログイン可否は `T_管理者Googleホワイトリスト` による許可制とする（GoogleユーザーID優先、メールは補助キー）。
- `T_認証アカウント.認証方式` は少なくとも `PASSWORD` / `GOOGLE` を保持する。
- `T_認証アカウント` に `GoogleユーザーID` / `Googleメール` を保持し、監査と突合に利用する。
- `T_ログイン履歴.認証方式` に実際のログイン方式を記録する。

## 5.2 管理者と会員ページの紐付け運用
- 管理者であっても `T_認証アカウント.会員ID` を必須で保持し、必ず自分の会員情報に紐づける。
- 管理者ログイン時は `管理者ページ` と `会員マイページ` の両方を表示可能にする。
- `T_管理者Googleホワイトリスト` 側にも `紐付け認証ID` / `紐付け会員ID` を保持し、起動時に二重チェックする。
- 紐付け不整合（ホワイトリストと認証アカウントの会員ID不一致）はログイン拒否とする。

## 6. 構築記録（実績）
- 実施日: 2026-02-25
- 実施アカウント: `k.noguchi@uguisunosato.or.jp`
- 対象スプレッドシート:
  - 名称: `枚方市介護支援専門員連絡協議会_DB`
  - ID: `1GVlIzOG1Tsqw8fBXgZ__c8u4oMu-4_WCf0H3aVLESKs`
  - URL: `https://docs.google.com/spreadsheets/d/1GVlIzOG1Tsqw8fBXgZ__c8u4oMu-4_WCf0H3aVLESKs/edit`
- 実行内容:
  - Apps Script の `setupDatabase()` を実行して、マスタ/テーブルシートを自動生成
  - `T_画面項目権限` の初期権限レコードを投入
  - マスタ参照列の入力規則（ドロップダウン）を設定
  - ヘッダー行保護（警告表示）を設定
  - 定義外シート `シート1` を削除
- 実行結果:
  - 実行ログにて `実行完了` を確認
  - 以下シートの作成を確認
  - マスタ:
    - `M_会員種別`, `M_会員状態`, `M_発送方法`, `M_郵送先区分`, `M_職員権限`, `M_職員状態`, `M_システムロール`, `M_開催形式`, `M_研修状態`, `M_申込状態`, `M_会費納入状態`
  - テーブル:
    - `T_会員`, `T_事業所職員`, `T_認証アカウント`, `T_ログイン履歴`, `T_画面項目権限`, `T_研修`, `T_研修申込`, `T_年会費納入履歴`, `T_管理者Googleホワイトリスト`
