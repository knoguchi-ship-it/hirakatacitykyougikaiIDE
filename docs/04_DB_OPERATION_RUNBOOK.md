# DB運用ランブック（スプレッドシート）

## 1. 目的
- 本システムのDB（Googleスプレッドシート）を、定義どおりに自動構築・再構築・清掃するための運用手順を記録する。

## 2. 対象DB
- 名称: `枚方市介護支援専門員連絡協議会_DB`
- スプレッドシートID: `1GVlIzOG1Tsqw8fBXgZ__c8u4oMu-4_WCf0H3aVLESKs`
- 参照コード: `backend/Code.gs` の `DB_SPREADSHEET_ID_FIXED`

## 3. 自動構築関数（Apps Script）
- `setupDatabase()`
  - マスタ/テーブルを作成
  - 初期値投入
  - 入力規則設定
  - ヘッダー保護設定
  - 定義外シート削除（例: `シート1`）

- `rebuildDatabaseSchema()`
  - 定義に沿ってDB構造を再構築
  - 定義外シートを削除
  - 返却値に削除シート一覧を含む

- `cleanupDatabaseSheets()`
  - 定義外シートのみ削除
  - 返却値に削除シート一覧を含む

## 4. 実行手順（Apps Scriptエディタ）
1. 対象プロジェクトを開く
2. 関数選択で `cleanupDatabaseSheets`（または `setupDatabase`）を選択
3. `実行` を押す
4. `実行完了` を確認する

## 5. 検証ポイント
- 不要シート `シート1` が存在しないこと
- 以下のシートが存在すること
  - `M_会員種別`, `M_会員状態`, `M_発送方法`, `M_郵送先区分`, `M_職員権限`, `M_職員状態`, `M_システムロール`, `M_開催形式`, `M_研修状態`, `M_申込状態`, `M_会費納入状態`
  - `T_会員`, `T_事業所職員`, `T_認証アカウント`, `T_ログイン履歴`, `T_画面項目権限`, `T_研修`, `T_研修申込`, `T_年会費納入履歴`, `T_管理者Googleホワイトリスト`

## 5.1 認証関連の運用検証
1. 会員認証
  - `T_認証アカウント` で `認証方式=PASSWORD` のレコードが存在すること
  - `ログインID` が重複していないこと
2. 管理者認証
  - `T_管理者Googleホワイトリスト` に許可されたGoogle主体が存在すること
  - `紐付け認証ID` / `紐付け会員ID` が `T_認証アカウント` / `T_会員` と一致すること
3. 監査
  - `T_ログイン履歴.認証方式` に `PASSWORD` または `GOOGLE` が記録されること

## 5.2 会費・研修表示の運用検証
1. 会費
  - `T_年会費納入履歴` の最新年度が未納の会員で、振込先口座情報が表示されること
  - 納入済の会員では振込先表示が出ないこと
2. 研修
  - 受付中研修で詳細本文が表示できること
  - 案内PDFリンクが有効で閲覧できること

## 6. 注意事項
- 運用アカウントは `k.noguchi@uguisunosato.or.jp` のみ使用する。
- 定義外シートを保持したい場合は、関数実行前に要件へ反映（`マスタ定義`/`テーブル定義` へ追加）する。
