# 開発引継ぎ書：枚方市介護支援専門員連絡協議会 会員管理システム

## 1. プロジェクト概要
本プロジェクトは、枚方市介護支援専門員連絡協議会の会員管理、研修申込、および年会費管理を効率化するためのWebアプリケーション（フロントエンドプロトタイプ）です。

### 主な目的
*   **会員種別の統合管理:** 「個人会員」と、複数の職員を抱える「事業所会員」を同一システムで管理する。
*   **ペーパーレス化:** 郵送中心の連絡体制から、メール・システム通知への移行を促進する。
*   **AI活用:** 生成AI（Gemini API）を用いた事務局業務（案内メール作成等）の効率化。

## 2. 技術スタック & 環境

*   **Framework:** React 19.2.3
*   **Build/Runtime:** Client-side rendering (ES Modules via `importmap` in `index.html`)
*   **Styling:** Tailwind CSS (CDN版 - プロトタイプ用構成)
*   **AI Integration:** Google Gemini API (`@google/genai` SDK)
*   **Visualization:** Recharts (ダッシュボードグラフ描画)
*   **Language:** TypeScript (TSX)

## 3. ディレクトリ構成と役割

| ファイルパス | 役割・概要 |
| :--- | :--- |
| `App.tsx` | **[重要]** アプリケーションのルート。グローバルなState管理（会員データ）、ルーティング、デモ用ユーザー切り替えロジックを担当。 |
| `types.ts` | データ型定義。ドメインモデル（`Member`, `Staff`, `Training`）の中核。 |
| `constants.ts` | モックデータ定義。初期表示用の会員データ、研修データを含む。 |
| `components/MemberForm.tsx` | **[重要]** 会員マイページ機能。プロフィール編集、研修申込を行う。個人/事業所の表示分岐ロジックを含む。 |
| `components/Sidebar.tsx` | ナビゲーションメニュー。権限（ADMIN/MEMBER）による表示制御を行う。 |
| `components/Dashboard.tsx` | 管理者用ダッシュボード。Rechartsを用いた統計表示。 |
| `components/TrainingList.tsx` | 管理者用研修管理。Gemini APIを使用したメール生成機能を含む。 |
| `services/geminiService.ts` | Google Gemini APIとの通信ロジック。 |

## 4. データモデルと設計思想

### 4.1 会員区分（`types.ts`）
本システム最大の特徴は、以下の2つの会員タイプを扱う点です。

1.  **個人会員 (`INDIVIDUAL`)**:
    *   1人のケアマネジャーが直接会員となる。
    *   `participatedTrainingIds` は `Member` 直下に保持。
2.  **事業所会員 (`BUSINESS`)**:
    *   介護事業所が会員となる（会員IDは1つ）。
    *   **職員リスト (`staff: Staff[]`)** を持ち、研修履歴や権限は各職員（`Staff`）オブジェクト内に保持される。
    *   連絡先情報（住所等）は事業所として1つだが、ログインや研修申込は「職員単位」で行われる。

### 4.2 State管理とデータの永続化
**現状のアーキテクチャ（React State Pattern）**

*   **データストア:** `App.tsx` 内の `members` ステートが「データベース」の役割を果たしています。
*   **データフロー:**
    1.  `App.tsx` が `members` を保持。
    2.  子コンポーネント（`MemberForm`等）へは、必要な `currentUser` (Memberオブジェクト) と `onSave` (コールバック関数) を渡す。
    3.  子コンポーネントで更新があった場合（研修申込など）、`onSave` を通じて `App.tsx` のStateを更新する。

> **⚠️ 重要課題:**
> 上記のStateリフトアップ（データの一元管理化）実装を行いましたが、**現在も「研修申込ボタン」を押下した後のデータ保持に関して不具合が報告されています。**
> 具体的には、画面遷移やユーザー切り替えを行うと、直前の申込情報がリセットされてしまう現象が確認されています。次期開発フェーズでの最優先調査事項です。

## 5. 主要機能の実装詳細

### 5.1 研修申込ロジック (`MemberForm.tsx`)
*   **事業所会員の挙動:**
    *   デモ用の「操作ユーザー選択」ドロップダウンで選択された `staffId` を使用。
    *   申込ボタン押下時、対象の `Staff` オブジェクト内の `participatedTrainingIds` 配列に研修IDを追加する。
*   **UX制御:**
    *   `setTimeout` を用いて800msの擬似的な通信ラグを発生させ、ローディング表示を行うことで、ユーザーに処理完了を認知させる実装を行っている。
    *   更新後は即座に `onSave` を呼び出し、親コンポーネントへデータを同期している（はずだが、前述のバグあり）。

### 5.2 デモモード (`App.tsx`)
*   画面右上のフローティングメニューにより、以下の切り替えが可能。
    *   **ロール切替:** 会員ビュー（MEMBER） / 事務局ビュー（ADMIN）
    *   **ユーザー切替:** 個人会員、または事業所内の特定職員としてのログインをシミュレーション。
*   `loginIdentities` 配列を `useMemo` で生成し、フラットなリストとしてドロップダウンに表示している。

### 5.3 AI活用機能 (`services/geminiService.ts`, `TrainingList.tsx`)
*   `generateTrainingEmail`: 研修オブジェクトを受け取り、Gemini API (`gemini-3-flash-preview`) を叩いてリマインドメールの文面を生成する。
*   **APIキー:** `process.env.API_KEY` を参照。環境変数として設定が必要。

## 6. 今後の開発タスク（Roadmap）

### フェーズ 0: 重要バグの修正（最優先）
*   **研修申込情報の永続化バグ:**
    *   `MemberForm` での `onSave` 呼び出しタイミング、`App.tsx` での `setMembers` の更新ロジック、およびオブジェクトの参照渡しに関する問題をデバッグし、画面遷移後も申込状態（「申込済」表示）が維持されるように修正する。

### フェーズ 1: バックエンド連携
現在はオンメモリ（State）管理です。実際の運用にはデータベース接続が必要です。
*   **実装案:** Firebase (Firestore) または Supabase を導入。
*   **修正箇所:** `App.tsx` の `useState` 初期値をDBからの `fetch` に置き換え、`handleMemberSave` 内で DB Update 処理を実装する。

### フェーズ 2: 認証機能の実装
現在はデモ用にドロップダウンでユーザーを切り替えています。
*   **実装案:** Firebase Auth等を導入し、ログイン画面を作成する。
*   **権限管理:** `types.ts` の `StaffRole` を使用し、管理者のみが特定画面にアクセスできるガード処理を強化する。

## 7. 既知の制限事項
1.  **【未解決バグ】研修申込の反映不具合:**
    *   研修に申し込んでも、他の画面に移動してから戻ると「未申込」に戻ってしまう現象が解決していません。State管理の実装不備の可能性があります。
2.  **データ消失:** ブラウザをリロードすると、すべての変更内容は破棄されます（モックデータに戻ります）。
3.  **排他制御:** 同一事業所の職員Aと職員Bが同時にデータを編集した場合の考慮は未実装です。
4.  **セキュリティ:** フロントエンド完結のため、APIキーの扱いやアクセス制御は本番運用レベルではありません。

---
作成日: 2025/05/XX
作成者: 開発チーム
